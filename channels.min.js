"use strict";function Channels(e){let t;const l=e=>{t&&"function"==typeof t&&t(e)},r=(e,t)=>{let l={};for(let n in e)t[n]&&("object"==typeof t[n]?l[n]=r(e[n],t[n]):l[n]=e[n]);return l},n=(e,t)=>{let l=!1;if("string"==typeof t&&"string"==typeof e){let l=new RegExp(t,"ig");return!e||!e.match(l)}for(let r in t){if(!e[r]){l=!0;break}if(typeof t[r]!=typeof e[r]){l=!0;break}if(typeof t[r]==typeof e[r]&&(l=n(e[r],t[r])))break}return l},a=e=>{let t,l=(t=e?e.toString():"/").toString().replace(/\/\//g,"/").replace(/^\//,"").replace(/\/$/,"").replace(/\/\//g,"/").split("/"),r="/"+l.slice(0,-1).join("/"),n=l.slice(-1)[0],a="";return"/"!==r&&(a="/"),{path:r+a+n,channel:r,key:n,slash:a}},i=(e,t)=>{let l=a(t).path;return{channel:()=>l,put:t=>o(e,l,t),get:t=>p(e,l,t),del:()=>c(e,l),list:t=>s(e,l,t),parse:(e=null)=>a((e||l).toString()),path:t=>{t||(t="/");let r="";return"/"!==l&&(r="/"),i(e,l+r+t)}}},o=(e,t,r)=>new Promise((n,i)=>{if(!r)return i({code:400,message:"Data is required."});if(t.match(/\!/))return i({code:400,message:"Invalid Path. The exclamation point (!) is a reserved character."});let{path:c,channel:s,key:h,slash:u}=a(t);e.put("!"+s+"!"+h,r).then(t=>{let r={event:t.event,path:s+u+(h||""),channel:s,key:h||"",timestamp:t.timestamp};if("/"===s&&(!h||""===h))return l(r),n(r);p(e,s).then(e=>{l(r),n(r)}).catch(t=>{o(e,s,{}).then(e=>{l(r),n(r)}).catch(i)})}).catch(i)}),p=(e,t,l)=>new Promise((n,i)=>{let{path:o,channel:p,key:c,slash:h}=a(t);e.get("!"+p+"!"+c).then(t=>{if(!t.value)return i({code:404,message:"Not Found"});let a={path:p+h+c,channel:p,key:c,data:t.value};l&&l.projection&&"object"==typeof l.projection&&(a=r(a,l.projection)),l&&l.children?s(e,a.path,l.children).then(e=>{e&&e.data?a.children=e.data:a.children=[],n(a)}):n(a)}).catch(i)}),c=(e,t)=>new Promise((r,n)=>{let{path:i,channel:o,key:p,slash:c}=a(t);e.list({gt:"!"+o+c+p+"!",lt:"!"+o+c+p+"￿/"}).then(t=>{t.unshift("!"+o+"!"+p),e.del(t).then(e=>{let t=e.keys.map(e=>e.replace(/^\!/,"").replace(/\!/g,"/").replace(/\/\//g,"/").replace(/\/\//g,"/")),n={event:e.event,paths:t,timestamp:e.timestamp};l(n),r(n)})})}),s=(e,t="/",l={})=>new Promise((a,i)=>{l&&"object"==typeof l||(l={});let o=t.toString(),p="";"/"!==o&&(p="/",o="/"+o.replace(/^\//,"").replace(/\/$/,""));let c="!"+o+"!"+(l.gt||""),s="!"+o+"!"+(l.lt||"￿");(l.deep||!1)&&(s="!"+o+p+"￿"),e.list({gt:c,lt:s,reverse:l.reverse||!1,values:l.values||!1,limit:l.limit||null}).then(e=>{let t=null,i=e.map(e=>{"object"!=typeof e&&(e={key:e});let n=e.key.replace(/^\!/,"").split("!")[0],a=e.key.replace(/^\!/,"").split("!")[1]||"/",i="";"/"!==n&&(i="/");let o={path:n+i+a,channel:n,key:a};return t=o.key,e.value&&(o.data=e.value),l.projection&&"object"==typeof l.projection&&(o=r(o,l.projection)),o}).filter(e=>!(l.values&&e.data&&l.filter&&"object"==typeof l.filter)||!n(e.data,l.filter)),o=null;t&&(o={},l.limit&&(o.limit=parseInt(l.limit)),l.reverse?(o.reverse=!0,o.lt=t):(o.reverse=!1,o.gt=t),l.values&&(o.values=!0),l.filter&&(o.filter=l.filter),l.projection&&(o.projection=l.projection)),a({data:i,cursor:o})})});let h=i(e,"/");return h.onEvent=(e=>{t=e}),h}"undefined"!=typeof module&&module&&module.exports&&(module.exports=Channels);